this folder contains ressources and files to host LRF on your server

eApps account creation
======================
Make a VM with the following parameters:
512Mb for test (quickly more for more intensive production usage).
CentOS 64bits with Tomcat 7

Domain name : [Ibrahima]

eApps VM setup
==============
Applications Install
From the application page: ISP Manager > Other settings > Application,
install the folowing application. For each application, select it and click the install button.
Select Java SE 7 and click install icon on the top right corner.
Java SE 7
Tomcat 7
PostgreSQL database server
PostgreSQL jdbc driver
Subversion
SMTP mail Server
Postgresql management tool /phppgadmin (php scripting langage needed!)
Firewall
Apache server
Pop/IMAP mail server 



Architecture
============
toujours.be is hosted with an httpd (Apache) instance in front of the Tomcat 7 server.
It enables:
 - a nice deployment html page (/var/www/html/deployment.html) to be displayed during redeploys,
 - the user generated (uploaded) content (such as user profile images) to be located outside of
   the tomcat webapp ROOT directory (which is deleted during every deployment).
   That content is kept in /var/www/html/gen and directly served by httpd.

Tuning Tomcat:min/max memory heap : https://support.eapps.com/index.php?/Knowledgebase/Article/View/203/65/user-guide---tomcat-installation-and-tuning

SCRIPTS
=======

The /opt/maintenance/ directory contains scripts and backups.
This folder must be put in /opt (otherwise you must change the BASE_FOLDER var in maintenance.sh and bin/config).

The main script is maintenance.sh. Its argument tells the action to perform (deploy, backup, restore, ...) as described further.
That script use variables defined in ./bin/config and bash functions defined in other files from the ./bin directory.

   
HTTPD
=====

The main configuration file is in /etc/httpd/conf/httpd.conf.
It refers all the *.conf file in /etc/httpd/conf.d/ directory.
The most important file is /etc/httpd/conf.d/LearningResourceFinder.conf
It has two versions:
 - LearningResourceFinder.conf.prod which redirect most requests (except /gen) to tomcat.
 - LearningResourceFinder.conf.dep which redirects all requests to the deployment.html page.
When switching between deployment and prod, LearningResourceFinder.conf is replaced by one of these 2 files.
It is done with the script
   maintenance.sh switch_httpd dep
or maintenance.sh switch_httpd prod
The switches are automatically done during the deploy script.
 
GEN
===

The /var/www/html/gen folder contains the images uploaded by the users (their pictures, the books) and the lucene index generated by the application.
It is backuped and restored with the command: maintenance.sh backupGen/restoreGen
The backup files are kept in /opt/maintenance/backup. 
The httpd (apache) server redirects the request for http://toujoursplus.be/gen to this folder (bypassing Tomcat).

On the developer machines, there is no httpd server => the gen folder is in ROOT/gen inside the working tomcat directory (somewhere deep in the workspace/.medatada/... with Eclipse).
It is erased each time you clean the tomcat server.

DB
==

The DB is managed by PostgreSQL.
It is backuped and restored with the command: maintenance.sh backupDB/restoreDB
The backup files are kept in /opt/maintenance/backup.
backup, restore script on PC,... XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxx

Cron backup
===========
Through the eApps ISP manager, add 2 cron tasks (Management Tools > Scheduler > New)
  - Period: every day
  - Command1: sh /opt/maintenance/maintenance.sh backupDB
  - Command2: sh /opt/maintenance/maintenance.sh backupGen
It will make backups run everyday. Our scripts (see maintenance.sh) activate some rolling mechanism to keep a few copies of the backups. Each backup is stored in a compressed .xz file.


Restore backups on developer's PC
=================================
....


Properties
==========
The /opt/maintenance/conf.properties will replace the LearningResourceFinder/src/secret.properties file during the packaging (ant tasks).
It contains the DB password and other sensible data that should not be in the open-source SVN with the source code.


Ant build
=========

Installed in /usr/share/ant in eApps VM
Commandline "ant" used in do_deployement script

................................

folder deployment page

  this folder contains the deployment page to be show when apache webserver is in deployment mode
  put theze file in the root of your apache webserver www content.
  You must replace all value in prod.properties with your own configuration value

folder MAINTENANCE
  
  

file environment

  put the content of this file int your own /etc/environment or just copy the file if you haven't already one.
