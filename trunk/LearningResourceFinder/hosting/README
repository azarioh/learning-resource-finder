this folder contains resources and files to host LRF on your server

eApps account creation
======================
Make a VM with the following parameters:
512Mb for test (quickly more for more intensive production usage).
CentOS 64bits with Tomcat 7

Domain name : [Ibrahima]

eApps VM setup
==============
Applications Install
From the application page: ISP Manager > Other settings > Application,
install the folowing application. For each application, select it and click the install button.
Select Java SE 7 for example and click install icon on the top right corner.

Java SE 7
Tomcat 7
PostgreSQL database server
PostgreSQL jdbc driver
Subversion
SMTP mail Server
Postgresql management tool /phppgadmin (php scripting langage needed!)
Firewall
Apache server
Pop/IMAP mail server 



Architecture
============
toujours.be is hosted with an httpd (Apache) instance in front of the Tomcat 7 server.
It enables:
 - a nice deployment html page (/var/www/html/deployment.html) to be displayed during redeploys,
 - the user generated (uploaded) content (such as user profile images) to be located outside of
   the tomcat webapp ROOT directory (which is deleted during every deployment).
   That content is kept in /var/www/html/gen and directly served by httpd.

Tuning Tomcat:min/max memory heap : https://support.eapps.com/index.php?/Knowledgebase/Article/View/203/65/user-guide---tomcat-installation-and-tuning

SCRIPTS
=======

The /opt/maintenance/ directory contains scripts and backups.
This folder must be put in /opt (otherwise you must change the BASE_FOLDER var in maintenance.sh and bin/config).

The main script is maintenance.sh. Its argument tells the action to perform (deploy, backup, restore, ...) as described further.
That script use variables defined in ./bin/config and bash functions defined in other files from the ./bin directory.

   
HTTPD
=====

The main configuration file is in /etc/httpd/conf/httpd.conf.
It refers all the *.conf file in /etc/httpd/conf.d/ directory.
The most important file is /etc/httpd/conf.d/LearningResourceFinder.conf
It has two versions:
 - LearningResourceFinder.conf.prod which redirect most requests (except /gen) to tomcat.
 - LearningResourceFinder.conf.dep which redirects all requests to the deployment.html page.
When switching between deployment and prod, LearningResourceFinder.conf is replaced by one of these 2 files.
It is done with the script
   maintenance.sh switch_httpd dep
or maintenance.sh switch_httpd prod
The switches are automatically done during the deploy script.
 
GEN
===
The /var/www/html/gen folder contains the images uploaded by the users (their pictures) and the lucene index generated by the application.
It is backuped and restored with the command: maintenance.sh backupGen/restoreGen
The backup files are kept in /opt/maintenance/backup. 
The httpd (apache) server redirects the request for http://toujoursplus.be/gen to this folder (bypassing Tomcat).

On the developer machines, there is no httpd server => the gen folder is in ROOT/gen inside the working tomcat directory (somewhere deep in the workspace/.medatada/... with Eclipse).
It is erased each time you clean the tomcat server.

DB(PROD)
========

The PostgreSQL DB is managed by phpPgAdmin : https://toujoursplus.be/pgadmin/
It is backuped and restored with the command: maintenance.sh backupDB/restoreDB
The backup files are kept in /opt/maintenance/backup.
backup, restore script on PC,... 

DB(DEV)
========
To restore prod DB on Dev windows desktop with pgadmin & psql.exe:

1)create lrfuser role in pgadmin 
2)create LRF DB in pgadmin 
3)under Dos terminal, change console codepage to windows codepage like this : chcp 1252 
4)in Start menu, launch SQL Shell(psql)
5)use lrfuser, database LRF and keep port/server by default
6)launch command, for example for a file sql (not archieved/compressed) like test.sql : \i C:/test.sql


Cron backup
===========
Through the eApps ISP manager, add 2 cron tasks (Management Tools > Scheduler > New)
  - Period: every day
  - Command1: sh /opt/maintenance/maintenance.sh backupDB
  - Command2: sh /opt/maintenance/maintenance.sh backupGen
It will make backups run everyday. Our scripts (see maintenance.sh) activate some rolling mechanism to keep a few copies of the backups. Each backup is stored in a compressed .xz file.
xz files should preferably be open with 7z tool (http://www.7-zip.org/)


Restore backups on developer's PC
=================================
....


Properties
==========
The /opt/maintenance/prod.properties will replace the LearningResourceFinder/src/secret.properties file during the packaging (ant tasks).
It contains the DB password and other sensible data that should not be in the open-source SVN with the source code.


Ant build
=========

Installed in /usr/share/ant in eApps VM
Commandline "ant" used in do_deployement script
The setup file : build.xml is here when application is deployed : /opt/tomcat7/webapps/ROOT/images/build.xml

................................

Folder deployment page
======================

  this folder contains the deployment page to be show when apache webserver is in deployment mode
  put theze file in the root of your apache webserver www content.
  You must replace all value in prod.properties with your own configuration value

Folder MAINTENANCE
==================
It's here : /opt/maintenance/
It contains 3 folders 
=> /bin : contains other script part called in maintenance.sh
=> /build : used like destination of compilation before deployement in webapps
=> /backup : contains all DB backup (subfolder /DB), all gen backup (/gen) and previous old war files (/oldwar)
& 2 files
=>well known maintenance.sh script
=>prod.properties
  

File environment
================
  put the content of this file int your own /etc/environment or just copy the file if you haven't already one.
  contains TOMCAT_HOME variable
  
FAQ
===

#see tomcat logs
tail -n300 /var/log/tomcat7/catalina.out

#start/restart/stop Apache/tomcat7
service httpd start
service httpd restart
service httpd stop
service tomcat7 start
service tomcat7 restart
service tomcat7 stop

#See remaining free memory
free -m

#Edit a file
nano filename.ext

